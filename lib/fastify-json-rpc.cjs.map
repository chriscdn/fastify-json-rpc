{"version":3,"file":"fastify-json-rpc.cjs","sources":["../src/fastify-plugin-errors.ts","../src/fastify-plugin.ts"],"sourcesContent":["import { ErrorObj } from \"./types\";\n\nconst ErrorCodes: Record<string, ErrorObj> = {\n  PARSEERROR: {\n    code: -32700,\n    message: \"Parse error\",\n  },\n  INVALIDREQUEST: {\n    code: -32600,\n    message: \"Invalid Request\",\n  },\n  METHODNOTFOUND: {\n    code: -32601,\n    message: \"Method not found\",\n  },\n  INVALIDPARAMS: {\n    code: -32602,\n    message: \"Invalid params\",\n  },\n  INTERNALERROR: {\n    code: -32603,\n    message: \"Internal error\",\n  },\n};\n\n// -32000 to -32099 is reserved!\n\nconst isErrorObj = (item: string | ErrorObj): item is ErrorObj =>\n  typeof item !== \"string\";\n\nclass CustomError extends Error {\n  public code: ErrorObj[\"code\"];\n  public data: ErrorObj[\"data\"] | null;\n\n  constructor(\n    message: string | ErrorObj = ErrorCodes.INTERNALERROR.message,\n    data: ErrorObj[\"data\"] = null,\n    code: ErrorObj[\"code\"] = ErrorCodes.INTERNALERROR.code,\n  ) {\n    if (isErrorObj(message)) {\n      super(message.message);\n      this.code = message.code;\n      this.data = message.data;\n    } else {\n      super(message);\n      this.code = code;\n      this.data = data;\n    }\n  }\n}\n\nexport { CustomError, ErrorCodes };\n","import isobject from \"isobject\";\nimport isFunction from \"is-function\";\nimport fp from \"fastify-plugin\";\nimport {\n  type FastifyPluginOptions,\n  type FastifyReply,\n  type FastifyRequest,\n} from \"fastify\";\nimport { CustomError, ErrorCodes } from \"./fastify-plugin-errors.ts\";\nimport { JSONRPCRequest, JSONRPCResponse, JSONRPCResponseError } from \"./types\";\n\n/**\n * Where you put this is important. Seems to work fine here.\n */\ndeclare module \"fastify\" {\n  interface FastifyInstance {\n    rpcify: (prefix: string, methods: RPCMethods) => void;\n  }\n}\n\ntype TID = JSONRPCRequest[\"id\"];\nexport type StructuredObject = { [key: string]: any } | any[];\ntype RPCMethods = Record<string, RPCMethod<any>>;\ntype Logger = FastifyRequest[\"log\"];\n\nexport type RPCMethod<T extends StructuredObject, R = any> = (\n  { params, logger }: { params: T; logger: Logger },\n) => Promise<R> | R;\n\nconst isJSONRPCRequestObj = (item: unknown): item is JSONRPCRequest => {\n  const testItem = item as JSONRPCRequest;\n  return (testItem?.jsonrpc === \"2.0\" && Boolean(testItem?.method));\n};\n\nconst successObject = <T>(id: TID, result: T): JSONRPCResponse<T> => {\n  return {\n    jsonrpc: \"2.0\",\n    result,\n    id,\n  };\n};\n\nconst errorObject = (\n  id: TID,\n  err: JSONRPCResponseError[\"error\"] | CustomError,\n) => {\n  if (err instanceof CustomError) {\n    // all good\n  } else {\n    const message = err.message;\n    err = new CustomError(ErrorCodes.INTERNALERROR, { internal: message });\n  }\n\n  const error = {\n    code: err.code,\n    data: err.data ?? 1234,\n    message: err.message,\n  };\n\n  // console.log(error);\n\n  return {\n    jsonrpc: \"2.0\",\n    error,\n    id,\n  };\n};\n\nconst processRequest = async (\n  req: FastifyRequest,\n  _res: FastifyReply,\n  methods: RPCMethods,\n  body: JSONRPCRequest,\n) => {\n  const jsonrpc = body.jsonrpc;\n  const methodName = body.method;\n  const id = body.id;\n\n  const params = body.params;\n\n  const method = methods[methodName];\n\n  if (jsonrpc !== \"2.0\" || methodName == null) {\n    return errorObject(id, ErrorCodes.INVALIDREQUEST);\n  } else if (params && !(isobject(params) || Array.isArray(params))) {\n    return errorObject(id, ErrorCodes.INVALIDREQUEST);\n  } else if (isFunction(method)) {\n    try {\n      return successObject(\n        id,\n        await method.call(methods, { params, logger: req.log }),\n      );\n    } catch (err) {\n      // keep this console.log for sanity sake\n      console.log(\"***** RPC Method threw an exception.\");\n      console.log(err);\n      console.log(\"*****\");\n\n      return errorObject(id, err);\n    }\n  } else {\n    return errorObject(id, ErrorCodes.METHODNOTFOUND);\n  }\n};\n\n// For whatever reason `fastify: FastifyInstance`, breaks here\nconst registerPlugin = (\n  // fastify: FastifyInstance,\n  fastify: any,\n  _opts: FastifyPluginOptions,\n  done,\n) => {\n  fastify.addSchema({\n    $id: \"json-rpc-request-body\",\n    type: \"object\",\n    properties: {\n      jsonrpc: {\n        type: \"string\",\n        enum: [\"2.0\"],\n      },\n      method: {\n        type: \"string\",\n      },\n      params: {\n        oneOf: [{ type: \"object\" }, { type: \"array\" }],\n      },\n      id: {\n        anyOf: [{ type: \"integer\" }, { type: \"string\" }, { type: \"null\" }],\n      },\n    },\n    required: [\"jsonrpc\", \"method\"],\n  });\n\n  fastify.addSchema({\n    $id: \"json-rpc-response\",\n    type: \"object\",\n    properties: {\n      jsonrpc: {\n        type: \"string\",\n        enum: [\"2.0\"],\n      },\n      result: {},\n      error: {\n        type: \"object\",\n        properties: {\n          code: {\n            type: \"number\",\n          },\n          message: {\n            type: \"string\",\n          },\n          data: {},\n        },\n        required: [\"code\"],\n      },\n      id: {\n        anyOf: [{ type: \"integer\" }, { type: \"string\" }, { type: \"null\" }],\n      },\n    },\n    oneOf: [\n      { type: \"object\", required: [\"jsonrpc\", \"id\", \"result\"] },\n      { type: \"object\", required: [\"jsonrpc\", \"id\", \"error\"] },\n    ],\n  });\n\n  fastify.decorate(\"rpcify\", (prefix: string, methods: RPCMethods) => {\n    fastify.post(prefix, {\n      schema: {\n        description: \"A JSON-RPC interface using POST.\",\n        params: {\n          type: \"object\",\n        },\n        body: {\n          oneOf: [\n            {\n              $ref: \"json-rpc-request-body#\",\n            },\n            {\n              type: \"array\",\n              items: {\n                $ref: \"json-rpc-request-body#\",\n              },\n            },\n          ],\n        },\n        response: {\n          200: {\n            oneOf: [\n              {\n                $ref: \"json-rpc-response#\",\n              },\n              {\n                type: \"array\",\n                items: {\n                  $ref: \"json-rpc-response#\",\n                },\n              },\n            ],\n          },\n        },\n      },\n      async handler(request, reply) {\n        const body = request.body as JSONRPCRequest | JSONRPCRequest[];\n\n        if (Array.isArray(body)) {\n          return reply.send(\n            await Promise.all(\n              body.map((item) => processRequest(request, reply, methods, item)),\n            ),\n          );\n        } else if (isJSONRPCRequestObj(body)) {\n          return reply.send(\n            await processRequest(request, reply, methods, body),\n          );\n        } else {\n          return reply.send(errorObject(null, ErrorCodes.PARSEERROR));\n        }\n      },\n    });\n  });\n\n  done();\n};\n\nconst fastifyPlugin = fp(registerPlugin);\n\nexport { fastifyPlugin };\n"],"names":["ErrorCodes","PARSEERROR","code","message","INVALIDREQUEST","METHODNOTFOUND","INVALIDPARAMS","INTERNALERROR","CustomError","_Error","data","_this","call","this","_assertThisInitialized","_wrapNativeSuper","Error","errorObject","id","err","_err$data","internal","jsonrpc","error","processRequest","req","_res","methods","body","methodName","method","params","Promise","resolve","isobject","Array","isArray","isFunction","logger","log","then","_method$call","result","successObject","_catch","console","e","reject","fastifyPlugin","fp","fastify","_opts","done","addSchema","$id","type","properties","enum","oneOf","anyOf","required","decorate","prefix","post","schema","description","$ref","items","response","handler","request","reply","_send","send","all","map","item","_Promise$all","isJSONRPCRequestObj","Boolean","_send2","_processRequest"],"mappings":"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"}