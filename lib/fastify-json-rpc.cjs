var e=require("isobject"),r=require("is-function"),t=require("fastify-plugin");function n(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/n(e),i=/*#__PURE__*/n(r),s=/*#__PURE__*/n(t);function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}function u(e,r){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e},u(e,r)}function p(e){var r="function"==typeof Map?new Map:void 0;return p=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(r){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return function(e,r,t){if(a())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,r);var o=new(e.bind.apply(e,n));return t&&u(o,t.prototype),o}(e,arguments,c(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),u(t,e)},p(e)}var d={PARSEERROR:{code:-32700,message:"Parse error"},INVALIDREQUEST:{code:-32600,message:"Invalid Request"},METHODNOTFOUND:{code:-32601,message:"Method not found"},INVALIDPARAMS:{code:-32602,message:"Invalid params"},INTERNALERROR:{code:-32603,message:"Internal error"}},l=/*#__PURE__*/function(e){function r(r,t,n){var o;return void 0===r&&(r=d.INTERNALERROR.message),void 0===t&&(t=null),void 0===n&&(n=d.INTERNALERROR.code),"string"!=typeof r?((o=e.call(this,r.message)||this).code=void 0,o.data=void 0,o.code=r.code,o.data=r.data):((o=e.call(this,r)||this).code=void 0,o.data=void 0,o.code=n,o.data=t),function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(o)}var t,n;return n=e,(t=r).prototype=Object.create(n.prototype),t.prototype.constructor=t,u(t,n),r}(/*#__PURE__*/p(Error)),f=function(e,r){return r instanceof l||(r=new l(d.INTERNALERROR,{internal:r.message})),{jsonrpc:"2.0",error:{code:r.code,data:r.data,message:r.message},id:e}},y=function(e,r,t,n){try{var s=n.method,c=n.id,a=n.params,u=t[s];return"2.0"!=n.jsonrpc||null==s?Promise.resolve(f(c,d.INVALIDREQUEST)):!a||o.default(a)||Array.isArray(a)?i.default(u)?Promise.resolve(function(r,n){try{var o=Promise.resolve(u.call(t,{params:a,logger:e.log})).then(function(e){return function(e,r){return{jsonrpc:"2.0",result:r,id:e}}(c,e)})}catch(e){return n(e)}return o&&o.then?o.then(void 0,n):o}(0,function(e){return console.log(e),f(c,e)})):Promise.resolve(f(c,d.METHODNOTFOUND)):Promise.resolve(f(c,d.INVALIDREQUEST))}catch(e){return Promise.reject(e)}},m=s.default(function(e,r,t){e.addSchema({$id:"json-rpc-request-body",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},method:{type:"string"},params:{oneOf:[{type:"object"},{type:"array"}]},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},required:["jsonrpc","method"]}),e.addSchema({$id:"json-rpc-response",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},result:{type:"string"},error:{type:"object"},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},oneOf:[{type:"object",required:["jsonrpc","id","result"]},{type:"object",required:["jsonrpc","id","error"]}]}),e.decorate("rpcify",function(r,t){e.post(r,{schema:{description:"A JSON-RPC interface using POST.",params:{type:"object"},body:{oneOf:[{$ref:"json-rpc-request-body#"},{type:"array",items:{$ref:"json-rpc-request-body#"}}]},response:{200:{oneOf:[{$ref:"json-rpc-response#"},{type:"array",items:{$ref:"json-rpc-response#"}}]}}},handler:function(e,r){try{var n=e.body;if(Array.isArray(n)){var o=r.send;return Promise.resolve(Promise.all(n.map(function(r){return y(e,0,t,r)}))).then(function(e){return o.call(r,e)})}if("2.0"===(null==(s=n)?void 0:s.jsonrpc)&&Boolean(null==s?void 0:s.method)){var i=r.send;return Promise.resolve(y(e,0,t,n)).then(function(e){return i.call(r,e)})}return Promise.resolve(r.send(f(null,d.PARSEERROR)))}catch(e){return Promise.reject(e)}var s}})}),t()});exports.CustomError=l,exports.ErrorCodes=d,exports.fastifyPlugin=m;
//# sourceMappingURL=fastify-json-rpc.cjs.map
