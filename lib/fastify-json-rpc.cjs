var e=require("isobject"),r=require("is-function"),t=require("fastify-plugin");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=/*#__PURE__*/o(e),i=/*#__PURE__*/o(r),s=/*#__PURE__*/o(t);function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(a=function(){return!!e})()}function u(e,r){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,r){return e.__proto__=r,e},u(e,r)}function p(e){var r="function"==typeof Map?new Map:void 0;return p=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(r){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return function(e,r,t){if(a())return Reflect.construct.apply(null,arguments);var o=[null];o.push.apply(o,r);var n=new(e.bind.apply(e,o));return t&&u(n,t.prototype),n}(e,arguments,c(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),u(t,e)},p(e)}var l={PARSEERROR:{code:-32700,message:"Parse error"},INVALIDREQUEST:{code:-32600,message:"Invalid Request"},METHODNOTFOUND:{code:-32601,message:"Method not found"},INVALIDPARAMS:{code:-32602,message:"Invalid params"},INTERNALERROR:{code:-32603,message:"Internal error"}},d=/*#__PURE__*/function(e){function r(r,t,o){var n;return void 0===r&&(r=l.INTERNALERROR.message),void 0===t&&(t=null),void 0===o&&(o=l.INTERNALERROR.code),"string"!=typeof r?((n=e.call(this,r.message)||this).code=void 0,n.data=void 0,n.code=r.code,n.data=r.data):((n=e.call(this,r)||this).code=void 0,n.data=void 0,n.code=o,n.data=t),function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(n)}var t,o;return o=e,(t=r).prototype=Object.create(o.prototype),t.prototype.constructor=t,u(t,o),r}(/*#__PURE__*/p(Error)),f=function(e,r){var t;return r instanceof d||(r=new d(l.INTERNALERROR,{internal:r.message})),{jsonrpc:"2.0",error:{code:r.code,data:null!=(t=r.data)?t:1234,message:r.message},id:e}},y=function(e,r,t,o){try{var s=o.method,c=o.id,a=o.params,u=t[s];return"2.0"!==o.jsonrpc||null==s?Promise.resolve(f(c,l.INVALIDREQUEST)):!a||n.default(a)||Array.isArray(a)?i.default(u)?Promise.resolve(function(r,o){try{var n=Promise.resolve(u.call(t,{params:a,logger:e.log})).then(function(e){return function(e,r){return{jsonrpc:"2.0",result:r,id:e}}(c,e)})}catch(e){return o(e)}return n&&n.then?n.then(void 0,o):n}(0,function(e){return console.log("***** RPC Method threw an exception."),console.log(e),console.log("*****"),f(c,e)})):Promise.resolve(f(c,l.METHODNOTFOUND)):Promise.resolve(f(c,l.INVALIDREQUEST))}catch(e){return Promise.reject(e)}},m=s.default(function(e,r,t){e.addSchema({$id:"json-rpc-request-body",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},method:{type:"string"},params:{oneOf:[{type:"object"},{type:"array"}]},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},required:["jsonrpc","method"]}),e.addSchema({$id:"json-rpc-response",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},result:{},error:{type:"object",properties:{code:{type:"number"},message:{type:"string"},data:{}},required:["code"]},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},oneOf:[{type:"object",required:["jsonrpc","id","result"]},{type:"object",required:["jsonrpc","id","error"]}]}),e.decorate("rpcify",function(r,t){e.post(r,{schema:{description:"A JSON-RPC interface using POST.",params:{type:"object"},body:{oneOf:[{$ref:"json-rpc-request-body#"},{type:"array",items:{$ref:"json-rpc-request-body#"}}]},response:{200:{oneOf:[{$ref:"json-rpc-response#"},{type:"array",items:{$ref:"json-rpc-response#"}}]}}},handler:function(e,r){try{var o=e.body;if(Array.isArray(o)){var n=r.send;return Promise.resolve(Promise.all(o.map(function(r){return y(e,0,t,r)}))).then(function(e){return n.call(r,e)})}if("2.0"===(null==(s=o)?void 0:s.jsonrpc)&&Boolean(null==s?void 0:s.method)){var i=r.send;return Promise.resolve(y(e,0,t,o)).then(function(e){return i.call(r,e)})}return Promise.resolve(r.send(f(null,l.PARSEERROR)))}catch(e){return Promise.reject(e)}var s}})}),t()});exports.CustomError=d,exports.ErrorCodes=l,exports.fastifyPlugin=m;
//# sourceMappingURL=fastify-json-rpc.cjs.map
