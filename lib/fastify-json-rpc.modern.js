import e from"isobject";import r from"is-function";import o from"fastify-plugin";const t={PARSEERROR:{code:-32700,message:"Parse error"},INVALIDREQUEST:{code:-32600,message:"Invalid Request"},METHODNOTFOUND:{code:-32601,message:"Method not found"},INVALIDPARAMS:{code:-32602,message:"Invalid params"},INTERNALERROR:{code:-32603,message:"Internal error"}};class s extends Error{constructor(e=t.INTERNALERROR.message,r=null,o=t.INTERNALERROR.code){"string"!=typeof e?(super(e.message),this.code=void 0,this.data=void 0,this.code=e.code,this.data=e.data):(super(e),this.code=void 0,this.data=void 0,this.code=o,this.data=r)}}const n=(e,r)=>{var o;return r instanceof s||(r=new s(t.INTERNALERROR,{internal:r.message})),{jsonrpc:"2.0",error:{code:r.code,data:null!=(o=r.data)?o:1234,message:r.message},id:e}},a=async(o,s,a,i)=>{const d=i.method,p=i.id,c=i.params,y=a[d];if("2.0"!==i.jsonrpc||null==d)return n(p,t.INVALIDREQUEST);if(c&&!e(c)&&!Array.isArray(c))return n(p,t.INVALIDREQUEST);if(!r(y))return n(p,t.METHODNOTFOUND);try{return((e,r)=>({jsonrpc:"2.0",result:r,id:e}))(p,await y.call(a,{params:c,logger:o.log}))}catch(e){return console.log("***** RPC Method threw an exception."),console.log(e),console.log("*****"),n(p,e)}},i=o((e,r,o)=>{e.addSchema({$id:"json-rpc-request-body",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},method:{type:"string"},params:{oneOf:[{type:"object"},{type:"array"}]},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},required:["jsonrpc","method"]}),e.addSchema({$id:"json-rpc-response",type:"object",properties:{jsonrpc:{type:"string",enum:["2.0"]},result:{},error:{type:"object",properties:{code:{type:"number"},message:{type:"string"},data:{}},required:["code"]},id:{anyOf:[{type:"integer"},{type:"string"},{type:"null"}]}},oneOf:[{type:"object",required:["jsonrpc","id","result"]},{type:"object",required:["jsonrpc","id","error"]}]}),e.decorate("rpcify",(r,o)=>{e.post(r,{schema:{description:"A JSON-RPC interface using POST.",params:{type:"object"},body:{oneOf:[{$ref:"json-rpc-request-body#"},{type:"array",items:{$ref:"json-rpc-request-body#"}}]},response:{200:{oneOf:[{$ref:"json-rpc-response#"},{type:"array",items:{$ref:"json-rpc-response#"}}]}}},async handler(e,r){const s=e.body;return Array.isArray(s)?r.send(await Promise.all(s.map(r=>a(e,0,o,r)))):"2.0"===(null==(i=s)?void 0:i.jsonrpc)&&Boolean(null==i?void 0:i.method)?r.send(await a(e,0,o,s)):r.send(n(null,t.PARSEERROR));var i}})}),o()});export{s as CustomError,t as ErrorCodes,i as fastifyPlugin};
//# sourceMappingURL=fastify-json-rpc.modern.js.map
